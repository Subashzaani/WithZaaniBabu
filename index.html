<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Private Chat</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Inter font -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Simple scrollbar for chat */
        .chat-window::-webkit-scrollbar {
            width: 6px;
        }
        .chat-window::-webkit-scrollbar-thumb {
            background-color: #4b5563; /* gray-600 */
            border-radius: 20px;
        }
    </style>
</head>
<body class="h-full bg-gray-900 text-white flex flex-col antialiased">

    <!-- Header -->
    <header class="bg-gray-800 shadow-md p-4 w-full">
        <h1 class="text-xl font-bold text-center text-white">Private Chat</h1>
        <div class="mt-2 text-center text-sm">
            <span class="font-medium text-gray-400">Status:</span>
            <span id="status-text" class="text-yellow-400">Connecting...</span>
        </div>
        <div class="mt-2 text-center text-xs break-all">
            <span class="font-medium text-gray-400">Your User ID:</span>
            <span id="user-id-display" class="text-gray-300 font-mono">Loading...</span>
        </div>
    </header>

    <!-- Error/Notification Bar -->
    <div id="error-bar" class="hidden p-3 bg-red-600 text-white text-center font-medium">
        <span id="error-text"></span>
    </div>

    <!-- Main Content -->
    <div id="app-content" class="flex-1 flex flex-col overflow-hidden">

        <!-- Connection UI -->
        <div id="connection-ui" class="p-6 w-full max-w-md mx-auto mt-8">
            <div class="bg-gray-800 p-6 rounded-lg shadow-xl">
                <h2 class="text-lg font-semibold text-center mb-4">Start a Chat</h2>
                <p class="text-sm text-gray-400 mb-4 text-center">Share your User ID with your partner and enter theirs below.</p>
                <div class="flex flex-col gap-4">
                    <input
                        type="text"
                        id="partner-id-input"
                        placeholder="Enter Partner's User ID"
                        class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500"
                    />
                    <button
                        id="connect-button"
                        class="w-full px-4 py-2 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 focus:ring-offset-gray-900 disabled:opacity-50 disabled:cursor-not-allowed"
                        disabled
                    >
                        Connect
                    </button>
                </div>
            </div>
        </div>

        <!-- Chat UI (Hidden by default) -->
        <div id="chat-ui" class="hidden flex-1 flex flex-col p-4 overflow-hidden">
            <div class="text-center mb-2 flex items-center justify-center gap-4">
                <div>
                    <span class="text-sm text-gray-400">Chatting with:</span>
                    <span id="partner-id-display" class="text-sm font-mono text-gray-300"></span>
                    <span id="partner-status" class="text-sm ml-1 text-gray-500">(Offline)</span>
                </div>
                <!-- Disconnect Button -->
                <button id="disconnect-button" class="px-3 py-1 bg-gray-600 text-white text-xs font-medium rounded-lg hover:bg-gray-700">
                    Disconnect
                </button>
            </div>
            
            <!-- Chat Messages Window -->
            <div id="chat-messages" class="chat-window flex-1 overflow-y-auto bg-gray-800 rounded-lg p-4 flex flex-col gap-2">
                <!-- Messages will be injected here -->
            </div>

            <!-- *** NEW: Typing Indicator *** -->
            <div id="typing-indicator" class="h-5 text-sm text-gray-400 italic px-4 hidden">
                Partner is typing...
            </div>

            <!-- Message Input -->
            <form id="message-form" class="mt-2 flex gap-2">
                <input
                    type="text"
                    id="message-input"
                    placeholder="Type your message..."
                    class="flex-1 px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500"
                    autocomplete="off"
                />
                <button
                    type="submit"
                    class="px-5 py-2 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 focus:ring-offset-gray-900"
                >
                    Send
                </button>
            </form>
        </div>

    </div>

    <!-- Firebase SDK -->
    <script type="module">
        // Import Firebase v9 SDK
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            signInAnonymously, 
            signInWithCustomToken, 
            onAuthStateChanged 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            getDoc, 
            setDoc, 
            onSnapshot, 
            setLogLevel,
            serverTimestamp,
            updateDoc,
            arrayUnion
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Global Variables ---
        let db, auth;
        let userId = null;
        let partnerId = null;
        let chatRoomId = null;
        let chatUnsubscribe = null;
        let presenceInterval = null;
        let partnerPresenceUnsubscribe = null;
        
        // *** NEW: Typing indicator state ***
        let isTyping = false;
        let typingTimeout = null;

        // Use a default appId, but it won't work for your project.
        // We get the real one from the config object below.
        const appId = 'default-app-id'; 

        // --- DOM Elements ---
        const statusText = document.getElementById('status-text');
        const userIdDisplay = document.getElementById('user-id-display');
        const connectButton = document.getElementById('connect-button');
        const partnerIdInput = document.getElementById('partner-id-input');
        
        const connectionUI = document.getElementById('connection-ui');
        const chatUI = document.getElementById('chat-ui');
        const partnerIdDisplay = document.getElementById('partner-id-display');
        const partnerStatus = document.getElementById('partner-status');
        const chatMessages = document.getElementById('chat-messages');
        const messageForm = document.getElementById('message-form');
        const messageInput = document.getElementById('message-input');
        const disconnectButton = document.getElementById('disconnect-button');
        const typingIndicator = document.getElementById('typing-indicator'); // *** NEW ***
        
        const errorBar = document.getElementById('error-bar');
        const errorText = document.getElementById('error-text');

        // --- Utility Functions ---

        /**
         * Shows an error message in the error bar.
         * @param {string} message - The error message to display.
         */
        function showError(message) {
            console.error(message); // Also log to console
            errorText.textContent = message;
            errorBar.classList.remove('hidden');
            // Hide after 5 seconds
            setTimeout(() => {
                errorBar.classList.add('hidden');
            }, 5000);
        }

        /**
         * Renders the chat messages to the screen.
         * @param {Array} messages - An array of message objects.
         */
        function renderMessages(messages = []) {
            chatMessages.innerHTML = ''; // Clear existing messages
            
            // Sort messages by timestamp (if timestamps exist)
            messages.sort((a, b) => {
                const tsA = a.timestamp ? a.timestamp.toMillis() : 0;
                const tsB = b.timestamp ? b.timestamp.toMillis() : 0;
                return tsA - tsB;
            });

            messages.forEach(msg => {
                const isMe = msg.senderId === userId;
                
                // Create a wrapper for bubble + timestamp
                const messageWrapper = document.createElement('div');
                messageWrapper.classList.add('flex', 'flex-col', 'max-w-xs', 'shadow');

                const messageBubble = document.createElement('div');
                messageBubble.textContent = msg.text;
                messageBubble.classList.add('p-3', 'rounded-xl', 'break-words');
                
                // *** NEW: Timestamp display ***
                const timeText = document.createElement('span');
                timeText.classList.add('text-xs', 'text-gray-400', 'mt-1');
                
                if (msg.timestamp) {
                    const date = msg.timestamp.toDate();
                    timeText.textContent = date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                } else {
                    timeText.textContent = 'Sending...';
                }

                if (isMe) {
                    messageWrapper.classList.add('ml-auto', 'items-end');
                    messageBubble.classList.add('bg-blue-600', 'text-white', 'rounded-br-none');
                    timeText.classList.add('text-right');
                } else {
                    messageWrapper.classList.add('mr-auto', 'items-start');
                    messageBubble.classList.add('bg-gray-700', 'text-white', 'rounded-bl-none');
                    timeText.classList.add('text-left');
                }
                
                messageWrapper.appendChild(messageBubble);
                messageWrapper.appendChild(timeText);
                chatMessages.appendChild(messageWrapper);
            });

            // Scroll to the bottom
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        /**
         * Updates this user's presence document with a current timestamp
         * and typing status.
         * @param {boolean} [typingStatus] - Optional typing status.
         */
        async function updatePresence(typingStatus) {
            if (!db || !userId) return;
            
            const presenceData = { 
                last_seen: serverTimestamp() 
            };

            // Only include isTyping if it's explicitly provided
            if (typingStatus !== undefined) {
                presenceData.isTyping = typingStatus;
            }

            try {
                // Use the projectId from your config
                const presenceDocRef = doc(db, 'artifacts', 'privatechat-8076d', 'public', 'data', 'presence', userId);
                // Use setDoc with merge to create/update the document
                await setDoc(presenceDocRef, presenceData, { merge: true });
            } catch (error) {
                console.warn("Failed to update presence:", error.message);
            }
        }

        /**
         * Listens to the partner's presence document.
         * @param {string} pid - The Partner's User ID.
         */
        function listenToPartnerPresence(pid) {
            if (partnerPresenceUnsubscribe) {
                partnerPresenceUnsubscribe();
            }
            // Reset status display on new listen
            partnerStatus.textContent = '(Offline)';
            partnerStatus.classList.remove('text-green-400');
            partnerStatus.classList.add('text-gray-500');
            typingIndicator.classList.add('hidden'); // *** NEW ***

            if (!pid) return;

            // Use the projectId from your config
            const presenceDocRef = doc(db, 'artifacts', 'privatechat-8076d', 'public', 'data', 'presence', pid);

            partnerPresenceUnsubscribe = onSnapshot(presenceDocRef, (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    const lastSeen = data.last_seen;
                    
                    // --- Check Online Status ---
                    if (lastSeen) {
                        const millis = lastSeen.toMillis();
                        const isOnline = (Date.now() - millis) < 15000; // 15 seconds
                        
                        if (isOnline) {
                            partnerStatus.textContent = '(Online)';
                            partnerStatus.classList.remove('text-gray-500');
                            partnerStatus.classList.add('text-green-400');
                        } else {
                            partnerStatus.textContent = '(Offline)';
                            partnerStatus.classList.remove('text-green-400');
                            partnerStatus.classList.add('text-gray-500');
                        }
                    } else {
                        partnerStatus.textContent = '(Offline)';
                        partnerStatus.classList.remove('text-green-400');
                        partnerStatus.classList.add('text-gray-500');
                    }

                    // --- *** NEW: Check Typing Status *** ---
                    if (data.isTyping) {
                        typingIndicator.classList.remove('hidden');
                    } else {
                        typingIndicator.classList.add('hidden');
                    }

                } else {
                    // No presence document exists
                    partnerStatus.textContent = '(Offline)';
                    partnerStatus.classList.remove('text-green-400');
                    partnerStatus.classList.add('text-gray-500');
                    typingIndicator.classList.add('hidden');
                }
            }, (error) => {
                console.error("Error listening to partner presence:", error.message);
                partnerStatus.textContent = '(Status Unknown)';
                partnerStatus.classList.remove('text-green-400');
                partnerStatus.classList.add('text-gray-500');
                typingIndicator.classList.add('hidden');
            });
        }


        /**
         * Listens for real-time updates to the chat room.
         */
        function listenToChat() {
            // Unsubscribe from any previous listener
            if (chatUnsubscribe) {
                chatUnsubscribe();
            }
            
            if (!chatRoomId) {
                showError("No chat room ID set.");
                return;
            }

            // Use the projectId from your config
            const chatDocRef = doc(db, 'artifacts', 'privatechat-8076d', 'public', 'data', 'chat_rooms', chatRoomId);
            
            chatUnsubscribe = onSnapshot(chatDocRef, (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    renderMessages(data.messages || []);
                } else {
                    // Document doesn't exist (e.g., first chat)
                    renderMessages([]);
                }
            }, (error) => {
                showError("Error listening to chat: " + error.message);
            });
        }

        // --- Event Handlers ---

        /**
         * Handles the "Connect" button click.
         */
        function handleConnect() {
            const pid = partnerIdInput.value.trim();
            
            if (!pid) {
                showError("Please enter a Partner User ID.");
                return;
            }
            if (pid === userId) {
                showError("You cannot chat with yourself.");
                return;
            }
            
            partnerId = pid;
            
            // Create a deterministic, sorted room ID
            const ids = [userId, partnerId].sort();
            chatRoomId = ids.join('_');
            
            console.log(`Connecting to chat room: ${chatRoomId}`);
            
            // Switch UI
            connectionUI.classList.add('hidden');
            chatUI.classList.remove('hidden');
            chatUI.classList.add('flex'); // Add flex to make it display correctly
            partnerIdDisplay.textContent = partnerId;
            
            // Start listening to the chat
            listenToChat();
            // Start listening to the partner's presence
            listenToPartnerPresence(partnerId);
        }

        /**
         * Handles sending a new message.
         * @param {Event} e - The form submit event.
         */
        async function handleSendMessage(e) {
            e.preventDefault();
            const messageText = messageInput.value.trim();
            
            if (!messageText) return;
            if (!chatRoomId) {
                showError("Not connected to a chat room.");
                return;
            }

            // *** NEW: Stop "typing" status on send ***
            if (typingTimeout) clearTimeout(typingTimeout);
            isTyping = false;
            updatePresence(false);

            const newMessage = {
                senderId: userId,
                text: messageText,
                timestamp: serverTimestamp() // *** NEW: Add timestamp ***
            };
            
            // Use the projectId from your config
            const chatDocRef = doc(db, 'artifacts', 'privatechat-8076d', 'public', 'data', 'chat_rooms', chatRoomId);
            
            try {
                // Atomically add the new message to the 'messages' array
                await setDoc(chatDocRef, { 
                    messages: arrayUnion(newMessage) 
                }, { merge: true });
                
                messageInput.value = ''; // Clear input
            } catch (error) {
                showError("Failed to send message: " + error.message);
                console.error("Send message error:", error);
            }
        }

        /**
         * *** NEW: Handles the "Disconnect" button click. ***
         */
        function handleDisconnect() {
            // Stop all listeners
            if (chatUnsubscribe) {
                chatUnsubscribe();
                chatUnsubscribe = null;
            }
            if (partnerPresenceUnsubscribe) {
                partnerPresenceUnsubscribe();
                partnerPresenceUnsubscribe = null;
            }
            
            // Clear state
            partnerId = null;
            chatRoomId = null;
            
            // Switch UI
            chatUI.classList.add('hidden');
            chatUI.classList.remove('flex');
            connectionUI.classList.remove('hidden');
            
            // Clear inputs/displays
            partnerIdInput.value = '';
            chatMessages.innerHTML = '';
        }

        /**
         * *** NEW: Handles the user typing in the input. ***
         */
        function handleTypingInput() {
            if (!isTyping) {
                // User just started typing
                isTyping = true;
                updatePresence(true);
            }

            // Reset the timeout
            if (typingTimeout) {
                clearTimeout(typingTimeout);
            }

            // Set a timeout to mark as "not typing" after 2 seconds
            typingTimeout = setTimeout(() => {
                isTyping = false;
                updatePresence(false);
            }, 2000);
        }

        /**
         * Signs the user in anonymously.
         */
        async function signIn() {
            try {
                // We are not using __initial_auth_token here, as we're using a specific project
                await signInAnonymously(auth);
            } catch (error) {
                showError("Authentication failed: " + error.message);
                statusText.textContent = 'Auth Failed';
                statusText.classList.replace('text-yellow-400', 'text-red-500');
            }
        }

        /**
         * Initializes Firebase app and services.
         */
        function initializeFirebase() {
            try {
                // *** THIS IS YOUR CONFIG ***
                const firebaseConfig = {
                    apiKey: "AIzaSyCqTG25Cm_A8kpDBzpYFVXZBggYD-aURFQ",
                    authDomain: "privatechat-8076d.firebaseapp.com",
                    projectId: "privatechat-8076d",
                    storageBucket: "privatechat-8076d.firebasestorage.app",
                    messagingSenderId: "43593347951",
                    appId: "1:43593347951:web:a47526dc86e2899676ae9a",
                    measurementId: "G-S7GTFRB1DY"
                };
                
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                setLogLevel('Debug'); // Enable debug logging

                // Listen for auth state changes
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        // User is signed in
                        userId = user.uid;
                        statusText.textContent = 'Authenticated';
                        statusText.classList.replace('text-yellow-400', 'text-green-500');
                        userIdDisplay.textContent = userId;
                        connectButton.disabled = false; // Enable connect button

                        // Start presence heartbeat
                        if (presenceInterval) {
                            clearInterval(presenceInterval);
                        }
                        updatePresence(); // Call immediately on sign-in
                        presenceInterval = setInterval(updatePresence, 10000); // And every 10s
                    } else {
                        // User is signed out or not yet signed in
                        userId = null;
                        statusText.textContent = 'Authenticating...';
                        statusText.classList.replace('text-green-500', 'text-yellow-400');
                        connectButton.disabled = true;
                        
                        // Stop presence heartbeat
                        if (presenceInterval) {
                            clearInterval(presenceInterval);
                            presenceInterval = null;
                        }
                        // Stop listening to partner
                        if (partnerPresenceUnsubscribe) {
                            partnerPresenceUnsubscribe();
                            partnerPresenceUnsubscribe = null;
                        }

                        signIn(); // Attempt to sign in
                    }
                });

            } catch (error) {
                showError("Failed to initialize Firebase: " + error.message);
                statusText.textContent = 'Error';
                statusText.classList.add('text-red-500');
            }
        }

        // --- App Entry Point ---
        window.onload = () => {
            initializeFirebase();
            
            // Attach event listeners
            connectButton.addEventListener('click', handleConnect);
            messageForm.addEventListener('submit', handleSendMessage);
            disconnectButton.addEventListener('click', handleDisconnect);
            messageInput.addEventListener('input', handleTypingInput); // *** NEW ***
        };
    </script>
</body>
</html>
